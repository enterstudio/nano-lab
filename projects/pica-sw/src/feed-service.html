<script>
(function() {
  
  var prefix = 'https://query.yahooapis.com/v1/public/yql?q='
  var suffix = '&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=___yqlCallback';
  var gcb = null;
  
  window.___yqlCallback = function(data) {
    gcb(data.query.results);
  };

  var feedService = {
    fetch: function(feed, cb) {
      gcb = cb;
      var s = document.createElement('script');
      s.src = prefix + encodeURIComponent('select * from rss where url="' + feed + '"') + suffix;
      document.body.appendChild(s);
    }
  };
  
  document.registerElement('feed-service', {
    prototype: {
      __proto__: HTMLElement.prototype,
      createdCallback: function() {
        // scrape up property values set before upgrade or set via attribute
        Nano.property(this, 'request');        
      },
      set request(request) {
        this._request = request;
        if (request) {
          // fetch the data from `feedService` (async)
          feedService.fetch(request,
            function(results) {
              // TODO(sjmiles): topic may have changed in the interim, do this better
              if (this._request === request) {
                this.feed = results;
              }
            }.bind(this)
          );
        }
      },
      set feed(feed) {
        this.dispatchEvent(new CustomEvent('feed-changed', {bubbles: false, detail: feed}));
      }
    }  
  });
  
})();
</script>